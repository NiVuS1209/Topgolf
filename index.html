<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Topgolf Abstimmung ğŸ„</title>
  <style>
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; color: white; overflow-y: auto; }

    #bgVideo { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
    body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 0; }

    header { background: rgba(0,0,0,0.3); padding: 40px 20px; text-align: center; position: relative; z-index: 1; }
    header h1 { margin: 0; font-size: 2.5rem; }
    header p { margin-top: 10px; font-size: 1.2rem; }

    .container { max-width: 900px; margin: 40px auto; padding: 0 20px; position: relative; z-index: 1; }
    .card { background: rgba(0,0,0,0.95); border-radius: 16px; padding: 24px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .card h2 { margin-top: 0; color: #395595; }
    .dates div { display: flex; justify-content: flex-start; align-items: center; margin-bottom: 10px; }
    .dates div label { cursor: pointer; display: flex; align-items: center; }
    .dates div label span { padding-left: 8px; }
    button { background: #395595; border: none; padding: 14px 24px; border-radius: 999px; font-size: 1rem; cursor: pointer; margin-top: 20px; }
    button:hover { background: #395595; }
    #votes li { margin-bottom: 8px; }
    #votes li button { margin-left: 8px; background: #395595; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; }

    footer { text-align: center; padding: 20px; opacity: 0.9; font-size: 0.9rem; position: relative; z-index: 1; background: rgba(0,0,0,0.95); border-radius: 16px; }

    @media screen and (max-width: 600px) {
      header h1 { font-size: 1.8rem; }
      header p { font-size: 1rem; }
      .container { margin: 20px auto; padding: 0 10px; }
      .card { padding: 16px; }
      button { width: 100%; padding: 12px; font-size: 1rem; }
      input[type="text"] { width: 100%; font-size: 1rem; }
    }
  </style>
</head>
<body>

<video id="bgVideo" autoplay muted playsinline loop></video>

<header>
  <h1>ğŸ„ Topgolf Weihnachtsgeschenk ğŸ„</h1>
  <p>WÃ¤hlt alle Termine aus, die euch passen!</p>
</header>

<div class="container">
  <div class="card">
    <h2>ğŸ Das Geschenk</h2>
    <p>Zu Weihnachten laden wir euch zu einem gemeinsamen <strong>Topgolf-Erlebnis</strong> ein!ğŸŒï¸ SpaÃŸ, Essen und eine gute Zeit zusammen ğŸ¯â›³</p>
  </div>

  <div class="card">
    <h2>ğŸ“… Termin-Abstimmung</h2>
    <form>
      <!-- Namensfeld -->
      <label style="display:block; margin-bottom:15px;">
        Dein Name:<br>
        <input type="text" id="name" required style="padding:8px;border-radius:8px;border:none;width:100%;max-width:300px;">
      </label>

      <!-- Neues Terminfeld, eine Zeile weiter unten -->
      <label style="display:block; margin-top:20px; margin-bottom:15px;">
        Neuen Termin hinzufÃ¼gen:<br>
        <input type="text" id="newDate" placeholder="z.B. 31. Januar" style="padding:8px;border-radius:8px;border:none;width:100%;max-width:300px;">
      </label>

      <button type="button" id="addDate">HinzufÃ¼gen</button>
      <div class="dates" id="datesContainer"></div>
      <button type="submit">Abstimmen</button>
    </form>
    <h3>ğŸ“ Bisherige Stimmen:</h3>
    <ul id="votes"></ul>
  </div>
</div>

<footer>â¤ï¸ Gemacht als WeihnachtsÃ¼berraschung fÃ¼r euch</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBt5gN3qzxY8g9RALFca9XbuD_0b4UeOx8",
    authDomain: "topgolf-termin.firebaseapp.com",
    projectId: "topgolf-termin",
    storageBucket: "topgolf-termin.firebasestorage.app",
    messagingSenderId: "736208185374",
    appId: "1:736208185374:web:291e91bbb7538376e0e60f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const form = document.querySelector('form');
  const votesList = document.getElementById('votes');
  const addDateBtn = document.getElementById('addDate');
  const newDateInput = document.getElementById('newDate');
  const datesContainer = document.getElementById('datesContainer');

  // Funktion zum Anzeigen eines Termins
  function displayDate(dateValue){
    const container = document.createElement('div');
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'dates';
    checkbox.value = dateValue;
    const span = document.createElement('span');
    span.textContent = dateValue;
    span.style.paddingLeft = '8px';
    label.appendChild(checkbox);
    label.appendChild(span);
    container.appendChild(label);
    datesContainer.appendChild(container);
  }

  // Termine aus Firebase laden
  const datesQuery = query(collection(db,'dates'), orderBy('created'));
  onSnapshot(datesQuery, snapshot=>{
    datesContainer.innerHTML=''; // vorherige lÃ¶schen
    snapshot.forEach(docSnap=>{
      displayDate(docSnap.data().name);
    });
  });

  // Neuen Termin hinzufÃ¼gen
  addDateBtn.addEventListener('click', async () => {
    const dateValue = newDateInput.value.trim();
    if(!dateValue) return;
    await addDoc(collection(db,'dates'), {name: dateValue, created: serverTimestamp()});
    newDateInput.value='';
  });

  // Abstimmen
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const selectedDates = Array.from(document.querySelectorAll('input[name="dates"]:checked')).map(el=>el.value);
    if(selectedDates.length===0){ alert('Bitte wÃ¤hle mindestens einen Termin aus.'); return; }

    const votesRef = collection(db,'votes');
    const snapshot = await getDocs(votesRef);
    let existingDoc = null;
    snapshot.forEach(docSnap=>{
      if(docSnap.data().name.toLowerCase()===name.toLowerCase()){
        existingDoc = docSnap;
      }
    });

    if(existingDoc){
      const currentDates = existingDoc.data().dates || [];
      const newDates = Array.from(new Set([...currentDates,...selectedDates]));
      await updateDoc(doc(db,'votes',existingDoc.id), {dates:newDates});
    } else {
      await addDoc(votesRef, {name, dates:selectedDates, created:serverTimestamp()});
    }

    form.reset();
  });

  // Abstimmungen anzeigen und lÃ¶schen
  const votesQuery = query(collection(db,'votes'), orderBy('created'));
  onSnapshot(votesQuery, snapshot=>{
    votesList.innerHTML='';
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const datesArray = Array.isArray(data.dates)?data.dates:[];
      const li = document.createElement('li');
      li.textContent = data.name + ' â†’ ' + datesArray.join(', ');

      const delBtn = document.createElement('button');
      delBtn.textContent = 'âœ–';
      delBtn.addEventListener('click', async ()=>{
        await deleteDoc(doc(db,'votes',docSnap.id));
      });

      li.appendChild(delBtn);
      votesList.appendChild(li);
    });
  });

  const video = document.getElementById('bgVideo');
  video.src='Topgolf.mp4';
  video.muted=true;
  video.play();

</script>

</body>
</html>
